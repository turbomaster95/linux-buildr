name: Makefile CI

env:
  VERSION: 6.18.2

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Cache the kernel
      id: cache-kernel
      uses: actions/cache@v4
      with:
        path: linux-${{ env.VERSION }}
        key: linux-${{ env.VERSION }}

    # https://kernel.org
    - name: Download Kernel
      if: steps.cache-kernel.outputs.cache-hit != 'true'
      run: wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ env.VERSION }}.tar.xz

    # https://docs.kernel.org/admin-guide/README.html#installing-the-kernel-source
    - name: Install the kernel source
      if: steps.cache-kernel.outputs.cache-hit != 'true'
      run: |
        xz -cd linux-${{ env.VERSION }}.tar.xz | tar xvf -
        cd linux-${{ env.VERSION }}
        make mrproper

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libelf-dev build-essential bc flex bison

    # https://docs.kernel.org/admin-guide/README.html#build-directory-for-the-kernel-source
    - name: Configure and build the kernel
      run: |
        cd linux-${{ env.VERSION }}
        make defconfig
        make -j $(nproc)
        
        # Prepare output directory
        mkdir -p ${{ github.workspace }}/output
        
        # The actual compressed kernel image created by the build process
        cp arch/x86/boot/bzImage ${{ github.workspace }}/output/bzImage

    - name: Download and Build Busybox
      run: |
        wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
        tar xvf busybox-1.36.1.tar.bz2
        cd busybox-1.36.1
        make defconfig
        
        # Configure Busybox
        # CONFIG_STATIC=y: Compile as one static binary (no external libs)
        # CONFIG_INSTALL_NO_USR=y: Install directly into /bin, not /usr/bin
        # CONFIG_FEATURE_INSTALLER=y: Enable the "make install" feature to create symlinks
        
        # Networking configuration to ensure no external dependencies are used:
        # CONFIG_FEATURE_PREFER_APPLETS=y: Use Busybox internal DNS/Net functions instead of system libs.
        # CONFIG_FEATURE_IPV6=n: Disable IPv6 support.
        # CONFIG_FEATURE_SUSv2=n: Disable legacy SUSv2 features (optional, often includes network bits).
        
        cat >> .config << EOF
        CONFIG_STATIC=y
        CONFIG_INSTALL_NO_USR=y
        CONFIG_FEATURE_INSTALLER=y
        CONFIG_FEATURE_PREFER_APPLETS=y
        CONFIG_FEATURE_IPV6=n
        CONFIG_FEATURE_SUSv2=n
        EOF
        
        make -j $(nproc)

    - name: Create initramfs image with Busybox
      run: |
        mkdir -p initramfs/{bin,etc,proc,sys,dev}
        
        # 'make install' automatically creates symlinks (sh, ls, cat, etc.) to the busybox binary
        # We point it to our specific initramfs bin directory
        cd busybox-1.36.1
        make CONFIG_PREFIX=${{ github.workspace }}/initramfs install
        
        cd ..
        
        # Create /init
        cat >> initramfs/init << EOF
        /bin/sh
        EOF
        sed -i '1i #!/bin/sh' initramfs/init
        
        # Create basic device nodes
        sudo mknod initramfs/dev/console c 5 1
        sudo mknod initramfs/dev/null c 1 3
        
        # Create the CPIO archive
        (cd initramfs; find . | cpio -o -H newc | gzip) > ${{ github.workspace }}/output/initramfs.cpio.gz

    - name: Upload Kernel and Initramfs
      uses: actions/upload-artifact@v4
      with:
        name: linux-rootfs
        path: |
          output/bzImage
          output/initramfs.cpio.gz
